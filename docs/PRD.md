# 快人快语 - 产品需求文档 (PRD)

## 1. 产品概述

**产品名称**: 快人快语 (FastVoice)

**产品定位**: 本地优先的 AI 语音输入法，支持离线语音识别和翻译

**核心价值**: 比打字快 4 倍，毫秒级响应，隐私安全

---

## 2. 功能需求

### 2.1 核心功能

#### 2.1.1 语音输入
| 功能项 | 说明 |
|--------|------|
| 触发方式 | 按住快捷键 (默认: macOS Fn / Windows Right Ctrl) |
| 工作流程 | 按住 → 开始录音 → 松开 → 识别 → 插入文字 |
| 识别引擎 | qwen-asr 本地模型 (sherpa-onnx) |
| 响应速度 | < 500ms |
| 支持语言 | 中文、英文 |

#### 2.1.2 智能翻译
| 功能项 | 说明 |
|--------|------|
| 翻译引擎 | Qwen2.5-1.5B-Instruct (离线) |
| 翻译模式 | **开关式选择**:
  - 直接翻译模式: 按翻译键说话，直接输出译文
  - 按键翻译模式: 先语音输入原文，再按翻译键翻译
| 默认快捷键 | Ctrl + Shift + T (可自定义) |
| 支持方向 | 中→英、英→中 |

#### 2.1.3 模型管理
| 功能项 | 说明 |
|--------|------|
| 语音识别模型 | 首次启动自动下载 qwen-asr |
| 翻译模型 | 用户首次启用翻译功能时**选择性下载** |
| 模型缓存 | 本地存储，避免重复下载 |
| 存储位置 | `models/models/` 目录 |

### 2.2 设置功能

#### 2.2.1 快捷键设置
- 语音输入快捷键 (支持组合键)
- 快速翻译快捷键
- 支持热键冲突检测

#### 2.2.2 音频设置
- 麦克风设备选择 (多设备)
- VAD 灵敏度调节 (静音阈值: 200-2000ms)
- 音频格式设置 (采样率: 16kHz)

#### 2.2.3 翻译设置
- 翻译模式选择 (开关: 直接翻译 / 按键翻译)
- 目标语言选择 (中文 / 英文)
- 翻译模型下载按钮 (显示模型大小)

#### 2.2.4 音频清理设置
- 自动清理开关
- 清理日期设置 (N 天前)
- 音频列表查看 (文件名/大小/日期)
- 批量删除功能

### 2.3 辅助功能

#### 2.3.1 托盘功能
- 系统托盘图标
- 右键菜单: 显示设置 / 隐藏 / 退出
- 状态指示: 识别中 / 空闲

#### 2.3.2 日志功能
- 操作日志记录
- 错误日志记录
- 日志级别可配置

---

## 3. 技术架构

### 3.1 技术选型

| 模块 | 技术栈 | 说明 |
|------|--------|------|
| 开发语言 | Python 3.10+ | 跨平台兼容 |
| 快捷键监听 | pynput | 跨平台全局热键 |
| 音频采集 | sounddevice | 实时音频流 |
| VAD 检测 | webrtcvad | 语音活动检测 |
| 语音识别 | sherpa-onnx + qwen-asr | 离线 STT |
| 翻译引擎 | transformers + Qwen2.5-1.5B | 离线翻译 |
| 文字注入 | pyautogui | 模拟键盘输入 |
| 设置界面 | PyQt6 | 原生界面 |
| 打包工具 | PyInstaller | 跨平台打包 |

### 3.2 项目结构

```
快人快语/
├── core/                          # 核心功能模块
│   ├── __init__.py
│   ├── hotkey_manager.py          # 全局快捷键监听
│   ├── audio_capture.py           # 音频采集 + VAD
│   ├── asr_engine.py              # 语音识别引擎
│   ├── translate_engine.py        # 翻译引擎
│   └── text_injector.py           # 文字注入
├── models/                        # 模型管理
│   ├── __init__.py
│   ├── model_manager.py           # 模型下载/管理/检测
│   └── models/                    # 本地模型存储目录
│       ├── asr/                   # 语音识别模型
│       └── translation/           # 翻译模型
├── ui/                            # 用户界面
│   ├── __init__.py
│   ├── settings_window.py         # 设置窗口
│   └── resources/                 # UI 资源 (图标等)
├── config/                        # 配置管理
│   ├── __init__.py
│   ├── settings.py                # 配置读写
│   ├── constants.py               # 常量定义
│   └── settings.json              # 用户配置文件
├── storage/                       # 数据存储
│   ├── __init__.py
│   └── audio_manager.py           # 音频文件管理
├── audio/                         # 音频文件存储
│   └── recordings/                # 录音文件
├── logs/                          # 日志文件
├── assets/                        # 资源文件
│   └── icons/                     # 图标
├── main.py                        # 主程序入口
├── requirements.txt               # 依赖列表
├── README.md                      # 说明文档
├── PRD.md                         # 产品需求文档
└── build.spec                     # PyInstaller 配置
```

### 3.3 核心流程

#### 语音输入流程
```
用户按住快捷键
    ↓
开始音频采集 (sounddevice)
    ↓
VAD 实时检测语音活动
    ↓
用户松开快捷键
    ↓
音频后处理 (降噪/格式转换)
    ↓
ASR 模型推理 (sherpa-onnx)
    ↓
返回识别文字
    ↓
文字注入到光标位置 (pyautogui)
```

#### 翻译流程

**直接翻译模式:**
```
用户按翻译快捷键
    ↓
开始音频采集
    ↓
ASR 识别 → 得到原文
    ↓
翻译模型推理 (Qwen2.5)
    ↓
返回译文
    ↓
文字注入到光标位置
```

**按键翻译模式:**
```
模式1: 语音输入 → 原文显示在屏幕
    ↓
用户按翻译快捷键
    ↓
获取最后一次识别的文字
    ↓
翻译模型推理
    ↓
译文替换原文 (或插入到光标位置)
```

---

## 4. 交互设计

### 4.1 设置界面布局

```
┌─────────────────────────────────────────────────┐
│  快人快语 设置                          □ ─ ✕   │
├─────────────────────────────────────────────────┤
│  ◆ 快捷键                                       │
│  ┌───────────────────────────────────────────┐  │
│  │  语音输入快捷键:    [ Fn           ]      │  │
│  │  快速翻译快捷键:    [ Ctrl+Shift+T  ]      │  │
│  └───────────────────────────────────────────┘  │
│                                                 │
│  ◆ 音频设置                                     │
│  ┌───────────────────────────────────────────┐  │
│  │  麦克风设备:    [ 内置麦克风 ▼     ]      │  │
│  │  VAD 灵敏度:    [ ████████○○   500ms ]    │  │
│  └───────────────────────────────────────────┘  │
│                                                 │
│  ◆ 翻译设置                                     │
│  ┌───────────────────────────────────────────┐  │
│  │  翻译模式:    [○] 直接翻译 [●] 按键翻译   │  │
│  │  目标语言:    [●] 英语 [○] 中文          │  │
│  │  翻译模型:    [ 未下载 - 1.2GB ]  [下载]  │  │
│  └───────────────────────────────────────────┘  │
│                                                 │
│  ◆ 音频管理                                     │
│  ┌───────────────────────────────────────────┐  │
│  │  [☑] 自动清理 [ 7 ] 天前的音频            │  │
│  │  [ 查看音频列表... ]                      │  │
│  └───────────────────────────────────────────┘  │
│                                                 │
│                    [ 保存 ]  [ 取消 ]           │
└─────────────────────────────────────────────────┘
```

### 4.2 音频管理窗口

```
┌─────────────────────────────────────────────────┐
│  音频文件管理                              ─ □ ✕│
├─────────────────────────────────────────────────┤
│  存储: 125.3 MB (48 个文件)                     │
│  [☑] 自动清理 [ 7 ] 天前的音频  [ 立即清理 ]    │
├─────────────────────────────────────────────────┤
│  ☐ │ 2024-01-15 14:30 │ voice_001.wav │ 2.1 MB │
│  ☑ │ 2024-01-14 09:15 │ voice_002.wav │ 1.8 MB │
│  ☐ │ 2024-01-13 16:45 │ voice_003.wav │ 2.5 MB │
│  ...                                           │
├─────────────────────────────────────────────────┤
│  [ 全选 ]  [ 反选 ]  [ 删除选中 ]               │
└─────────────────────────────────────────────────┘
```

---

## 5. 非功能需求

### 5.1 性能要求
- 语音识别延迟 < 500ms
- 翻译延迟 < 2s
- 内存占用 < 2GB (模型加载后)

### 5.2 兼容性要求
- macOS 10.15+ (Intel & Apple Silicon)
- Windows 10+ (64-bit)

### 5.3 安全性要求
- 音频数据本地存储
- 不上传任何用户数据
- 模型下载使用官方源

---

## 6. 开发计划

### Phase 1: 核心功能 (Week 1-2)
- [ ] 快捷键监听
- [ ] 音频采集 + VAD
- [ ] 语音识别集成
- [ ] 文字注入

### Phase 2: 翻译功能 (Week 3)
- [ ] 翻译引擎集成
- [ ] 翻译模式实现
- [ ] 模型管理

### Phase 3: 界面开发 (Week 4)
- [ ] 设置界面 (PyQt6)
- [ ] 音频管理界面
- [ ] 托盘图标

### Phase 4: 打包测试 (Week 5)
- [ ] PyInstaller 配置
- [ ] 双平台测试
- [ ] Bug 修复

---

## 7. 风险与挑战

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| macOS 权限问题 | 高 | 提供权限申请指引 |
| 模型下载失败 | 中 | 提供手动下载方式 |
| 快捷键冲突 | 中 | 冲突检测提示 |
| 跨平台兼容 | 中 | 充分测试双平台 |
