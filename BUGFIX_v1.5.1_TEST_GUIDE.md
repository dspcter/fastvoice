# FastVoice 注入问题修复 - v1.5.1 测试指南

## 修复日期
2026-01-19 (v1.5.1)

## 关键修复

### 1. 修复剪贴板恢复逻辑
**问题**：退出时跳过剪贴板恢复，导致剪贴板保留注入内容
**修复**：无论什么情况都恢复剪贴板

### 2. 修复延迟重置机制
**问题**：0.5 秒延迟重置导致退出时序竞争
**修复**：立即重置注入标志，在监听器中添加关闭状态检查

### 3. 增强事件忽略机制
**问题**：监听器只检查 `_is_injecting` 标志，无法处理退出时的情况
**修复**：添加双重检查（注入标志 + 关闭状态）

## 测试步骤

### 测试 1：正常注入（基础测试）

**步骤**：
1. 启动应用
2. 打开 TextEdit 或其他文本编辑器
3. 将光标定位到文本编辑器中
4. 按下快捷键触发语音输入
5. 说一段简短的话（如"测试一下"）
6. 释放快捷键

**预期结果**：
- 日志显示识别结果
- 文字正确出现在文本编辑器中
- 没有额外的注入行为

**关键日志**：
```
📋 [MacOSInjector] 开始剪贴板粘贴流程
⏱️  [MacOSInjector] 等待焦点稳定 (0.05s)...
✅ [MacOSInjector] 粘贴成功
✓ [MacOSInjector] 剪贴板已恢复到原内容
```

---

### 测试 2：快速退出测试（关键测试）

**步骤**：
1. 启动应用
2. 打开 TextEdit
3. 将光标定位到文本编辑器中
4. 按下快捷键触发语音输入
5. **在识别完成前立即点击退出**

**预期结果**：
- 应用正常退出
- 没有任何文字被注入到 TextEdit
- 没有错误或崩溃

**关键日志**：
```
🛑🛑🛑 [shutdown] 步骤1/7: 已设置应用关闭标志
🧹🧧🧧 [shutdown] 步骤1.5/7: 立即清理注入器
🛑🛑🛑 [监听器] 全局关闭标志已设置，忽略事件
✓ [MacOSInjector] 剪贴板已恢复到原内容
```

---

### 测试 3：连续注入测试

**步骤**：
1. 启动应用
2. 打开 TextEdit
3. 连续触发 5 次语音输入
4. 每次说简短的话

**预期结果**：
- 所有识别结果都正确注入
- 没有重复注入
- 没有注入失败

**关键日志**：
```
[监听器] _is_injecting=True，忽略注入事件: Command+V
```

---

### 测试 4：不同应用测试

**步骤**：
在以下应用中测试注入：
- TextEdit
- VS Code
- Terminal
- Safari（地址栏）
- 微信/钉钉

**预期结果**：
- 所有应用中都能正确注入
- 没有应用特定的失败

---

### 测试 5：长时间运行测试

**步骤**：
1. 启动应用
2. 每隔 30 秒触发一次语音输入
3. 持续测试 10 分钟
4. 中途进行 2-3 次退出和重新启动

**预期结果**：
- 所有注入都成功
- 退出和启动都正常
- 没有内存泄漏

---

## 日志分析

### 正常注入的日志流程

```
1. 📥 [主线程] 收到 ASR 结果: '测试一下'
2. 📝 [TextInjector] 开始注入文字: '测试一下...'
3. 📋 [MacOSInjector] 开始剪贴板粘贴流程
4. ⏱️  [MacOSInjector] 等待焦点稳定 (0.05s)...
5. 🔄 尝试 1/3
6. ⌨️  模拟 Command+V 粘贴...
7. ✓ Command+V 已执行
8. ✅ 粘贴成功
9. ✓ [MacOSInjector] 剪贴板已恢复到原内容
```

### 退出时阻止注入的日志流程

```
1. 🚪🚪🚪 [shutdown] 开始关闭应用...
2. ⛔⛔⛔ [shutdown] 步骤1/7: 已设置应用关闭标志
3. 🧹🧧🧧 [shutdown] 步骤1.5/7: 立即清理注入器
4. 🛑🛑🛑 [MacOSInjector] cleanup() 开始
5. 🛑🛑🛑 [ASR回调] 应用正在关闭，忽略 ASR 结果
6. 🛑🛑🛑 [监听器] 全局关闭标志已设置，忽略事件
7. ✓ [MacOSInjector] 剪贴板已恢复到原内容
```

### 监听器忽略注入事件的日志

```
⚠️ [监听器] 忽略注入事件: Command+V (keycode=0x9, flags=1048576)
```

---

## 问题排查

### 如果注入还是失败

**检查项**：
1. 确认日志中没有 "🛑🛑🛑" 标志（说明不是被关闭检查阻止）
2. 确认剪贴板验证通过
3. 确认 Command+V 已执行

**可能原因**：
- 焦点不在正确的应用
- 目标应用不接受剪贴板粘贴
- 权限问题（辅助功能权限）

### 如果退出时还是有注入

**检查项**：
1. 确认日志中关闭标志已设置
2. 确认监听器忽略了后续事件
3. 确认剪贴板已恢复

**可能原因**：
- CGEvent 事件在关闭标志设置前已发送
- 系统事件队列的处理延迟

---

## 版本对比

### v1.5.0 vs v1.5.1

| 修复点 | v1.5.0 | v1.5.1 |
|--------|--------|--------|
| 剪贴板恢复 | 退出时跳过 | 始终恢复 |
| 注入标志重置 | 延迟 0.5s | 立即重置 |
| 监听器检查 | 只检查注入标志 | 双重检查（注入标志+关闭状态） |

---

## 预期改进

### 退出时自动注入问题
- **修复前**：退出时会自动注入内容
- **修复后**：退出时不会有任何注入行为

### 注入可靠性
- **修复前**：应用开启时可能注入失败
- **修复后**：注入更加可靠（焦点等待、改进的验证）

---

## 下一步

如果测试后问题仍然存在，请提供：
1. 完整的日志输出
2. 具体的测试步骤
3. 问题发生的频率（偶尔/经常/总是）

这将帮助我们进一步诊断和修复问题。
