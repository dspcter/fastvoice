# 快人快语 v1.2.1 版本说明

**发布日期**: 2026-01-06

---

## 🎯 **核心更新**

### 1. **智能超时策略**
- 录音状态：使用按键事件时间，支持 60s 长录音
- 尾音收集状态：由 200ms 定时器保护，跳过 watchdog 检查
- 过渡状态：严格 10s 超时保护，防止状态卡死

### 2. **统一的定时器管理系统**
- 新增 `_active_timers` 列表跟踪所有活跃定时器
- 实现 `_schedule_timer()` 统一创建定时器
- 实现 `_cleanup_all_timers()` 统一清理定时器
- 防止定时器泄漏，确保资源正确释放

### 3. **Listener 自动恢复机制优化**（重点修复）
- **问题**: Listener 线程活着但不接收键盘事件（静默失效）
- **修复**:
  - 重启后更新 `_last_key_event_time`，避免 watchdog 误判
  - 清空 `_pressed_keys`，确保按键状态同步
  - 添加 10 秒重启冷却期，给新 listener 稳定时间
- **效果**: 解决了长时间不使用后按键失效的问题

### 4. **录音时长调整**
- 从 30s 增加到 60s（3 处配置）
- 位置：
  - `config/constants.py`
  - `core/audio_capture.py`
  - `core/audio/recording_controller.py`

---

## 🐛 **Bug 修复**

### 修复 1: Watchdog 超时导致录音卡住
- **问题**: 按住快捷键 >10s，录音状态被 watchdog 重置
- **原因**: 录音状态下没有状态转换活动，被 watchdog 误判为失效
- **解决**: 录音状态使用按键事件时间，不检查状态转换活动

### 修复 2: Listener 重启后立即失效
- **问题**: 自动重启看似成功，但 30 秒后又失效
- **原因**: 重启后 `_last_key_event_time` 未更新，watchdog 还是用旧时间戳
- **解决**: 重启后更新时间戳，并添加冷却期

### 修复 3: 定时器泄漏
- **问题**: 多个 `threading.Timer` 创建后未统一管理
- **解决**: 实现统一的定时器管理系统，所有定时器都被跟踪和清理

### 修复 4: 状态机健壮性
- **问题**: 某些异常情况下状态卡死无法恢复
- **解决**: 所有状态都有明确的超时保护，`_reset_state()` 是幂等的

---

## 📋 **代码质量改进**

### 线程安全验证
- 所有 `_reset_state()` 调用都在锁保护下
- 使用可重入锁（`threading.RLock`）避免死锁
- 所有定时器回调都正确使用锁

### 状态机完整性
- 所有 8 个状态都有明确的进入和退出路径
- 非法转换会被 `_transition_state()` 拒绝
- 状态转换验证覆盖率 100%

### 异常处理
- 所有关键路径都有异常捕获
- 异常信息详细记录到日志
- 失败后有合理的降级处理

---

## 📊 **性能优化**

- **内存管理**: 定时器统一清理，防止内存泄漏
- **锁粒度**: 优化锁的使用范围，减少竞争
- **资源清理**: 所有资源都有明确的清理路径

---

## ⚙️ **配置变更**

| 配置项 | 旧值 | 新值 | 位置 |
|--------|------|------|------|
| 最大录音时长 | 30s | 60s | `config/constants.py` |
| Watchdog 超时 | 10s | 10s（智能策略） | `core/hotkey_manager.py` |
| 录音状态超时 | 10s | 无限制（按键事件） | `core/hotkey_manager.py` |

---

## 🚀 **已知限制和长期方案**

### HIToolbox 崩溃（macOS）
- **根本原因**: pynput 在后台线程调用 macOS Input Method APIs
- **当前缓解**: 健壮的状态管理、定时器清理、减少状态转换
- **长期方案**: 考虑替换 pynput 为 PyObjC + CGEvent

---

## 📝 **使用建议**

1. **长时间不使用后**: 第一次按键可能需要等待 10 秒冷却期
2. **录音时长**: 最长支持 60 秒，超过会自动停止
3. **自动恢复**: Listener 失效会自动重启，无需手动干预

---

## 🔄 **升级路径**

从 v1.0.x 升级到 v1.2.1：
1. 备份当前版本
2. 替换文件
3. 重启应用即可（无需额外配置）

---

## 📞 **反馈**

如有问题，请查看日志文件：
- `logs/FastVoice.log`

---

**开发团队**: Claude Code
**最后更新**: 2026-01-06
